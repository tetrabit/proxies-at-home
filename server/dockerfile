# syntax=docker/dockerfile:1

# --- Install deps for the server package
FROM node:20-alpine AS deps
WORKDIR /app

# better-sqlite3 requires build tools for native module compilation
RUN apk add --no-cache python3 make g++

# package-lock.json installs @tetrabit/scryfall-cache-client from a local workspace path:
# file:../shared/scryfall-client (relative to /app/server).
# Build the workspace package inside the image so docker builds don't depend on
# prebuilt dist artifacts existing in the worktree.
COPY shared/scryfall-client/package.json shared/scryfall-client/package-lock.json shared/scryfall-client/tsconfig.build.json shared/scryfall-client/index.ts shared/scryfall-client/schema.d.ts /app/shared/scryfall-client/
COPY shared/scryfall-client/README.md /app/shared/scryfall-client/README.md
RUN npm ci --prefix /app/shared/scryfall-client && npm run build --prefix /app/shared/scryfall-client

WORKDIR /app/server

# Install only server deps
COPY server/package*.json ./
RUN npm ci

# --- Build TypeScript -> server/dist/server/src/index.js
FROM node:20-alpine AS build
WORKDIR /app/server

# Reuse installed node_modules from deps
COPY --from=deps /app/server/node_modules ./node_modules

# Copy the actual server source (tsconfig.json is inside server/)
COPY server/ ./

# Copy shared types (referenced by server code)
COPY shared/ ../shared/

# Ensure the workspace dependency has built dist available during TS compile.
# npm may link file: dependencies to /app/shared/scryfall-client.
COPY --from=deps /app/shared/scryfall-client /app/shared/scryfall-client

# This should output to /app/server/dist/server/src/index.js
RUN npm run build

# --- Runtime image
FROM node:20-alpine AS runtime
WORKDIR /app/server
ENV NODE_ENV=production

# Only ship what we need to run: the built dist
COPY --from=build /app/server/dist ./dist

# package-lock.json still resolves @tetrabit/scryfall-cache-client via file:../shared/scryfall-client.
# Copy the built workspace package from deps stage before installing prod deps.
COPY --from=deps /app/shared/scryfall-client /app/shared/scryfall-client

# Server package.json + lockfile for prod deps
COPY server/package*.json ./
RUN npm ci --omit=dev

# Koyeb will set PORT; make sure your code uses process.env.PORT
EXPOSE 3001
CMD ["node", "dist/server/src/index.js"]
